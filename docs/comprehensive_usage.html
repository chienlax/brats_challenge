<!DOCTYPE html><html><head>
      <title>comprehensive_usage</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\Quang Chien\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.20\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="brats-post-treatment-toolkit--comprehensive-cli-usage">BraTS Post-treatment Toolkit – Comprehensive CLI Usage </h1>
<p><strong>Last Updated:</strong> October 5, 2025</p>
<p>This document consolidates the end-to-end workflow for every maintained script in the <code>scripts/</code> directory. It expands on <code>docs/usage_guide.md</code>, the MONAI and nnU-Net installation notes, and the inline help bundled with each CLI. Keep it close whenever you stage data, train models, run inference, or evaluate results.</p>
<hr>
<h2 id="1-before-you-start">1. Before you start </h2>
<h3 id="11-repository-layout-refresher">1.1 Repository layout refresher </h3>
<ul>
<li>Source code lives under <code>apps/</code> (Dash apps) and <code>scripts/</code> (CLI utilities).</li>
<li>Raw BraTS cases belong in <code>training_data/</code>, <code>training_data_additional/</code>, or <code>validation_data/</code>; keep them out of Git.</li>
<li>Generated assets go into <code>outputs/</code> (ignored by Git) to preserve reproducibility.</li>
</ul>
<h3 id="12-python-environments">1.2 Python environments </h3>
<ul>
<li>
<p><strong>Core tooling, visualization, statistics</strong><br>
Interpreter: <code>.venv\Scripts\python.exe</code><br>
Commands (PowerShell):</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>python <span class="token operator">-</span>m venv <span class="token punctuation">.</span>venv
<span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv\Scripts\Activate<span class="token punctuation">.</span>ps1
python <span class="token operator">-</span>m pip install <span class="token operator">--</span>upgrade pip
pip install <span class="token operator">-</span>r requirements<span class="token punctuation">.</span>txt
</code></pre></li>
<li>
<p><strong>nnU-Net dataset prep &amp; evaluation</strong><br>
Interpreter: <code>.venv_nnunet\Scripts\python.exe</code><br>
Commands (PowerShell):</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>python <span class="token operator">-</span>m venv <span class="token punctuation">.</span>venv_nnunet
<span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python <span class="token operator">-</span>m pip install <span class="token operator">--</span>upgrade pip
pip install <span class="token operator">-</span>r requirements_nnunet<span class="token punctuation">.</span>txt <span class="token operator">--</span>extra-index-url https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>pytorch<span class="token punctuation">.</span>org/whl/cu124
</code></pre></li>
<li>
<p><strong>MONAI fine-tuning &amp; inference</strong><br>
Interpreter: <code>.venv_monai\Scripts\python.exe</code><br>
Commands (PowerShell):</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>python <span class="token operator">-</span>m venv <span class="token punctuation">.</span>venv_monai
<span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python <span class="token operator">-</span>m pip install <span class="token operator">--</span>upgrade pip
pip install <span class="token operator">--</span>index-url https:<span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>pytorch<span class="token punctuation">.</span>org/whl/cu124 torch==2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>0 torchvision==0<span class="token punctuation">.</span>21<span class="token punctuation">.</span>0 torchaudio==2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>0
pip install <span class="token string">"monai[all]"</span> nibabel pydicom ipywidgets==8<span class="token punctuation">.</span>1<span class="token punctuation">.</span>2
pip uninstall <span class="token operator">-</span>y pytensor
pip install <span class="token operator">-</span>U filelock
</code></pre></li>
</ul>
<blockquote>
<p><strong>Tip:</strong> Always re-run the appropriate <code>Activate.ps1</code> when you open a new shell. If PowerShell blocks scripts, run <code>Set-ExecutionPolicy -Scope CurrentUser RemoteSigned</code> once.</p>
</blockquote>
<h3 id="13-data-staging-checklist">1.3 Data staging checklist </h3>
<ol>
<li>Extract each BraTS case into its own folder (<code>BraTS-GLI-xxxxx-yyy/</code>).</li>
<li>Confirm the five canonical files exist: <code>-t1c</code>, <code>-t1n</code>, <code>-t2f</code>, <code>-t2w</code>, <code>-seg</code> (all <code>.nii.gz</code>).</li>
<li>Mirror the folders into your chosen dataset roots (<code>training_data*/</code> for training, <code>validation_data/</code> for hold-outs).</li>
<li>Keep directories read-only; scripts never mutate raw data.</li>
</ol>
<h3 id="14-environment-variables-for-nnu-net">1.4 Environment variables for nnU-Net </h3>
<p>When preparing datasets or evaluating nnU-Net results, make sure the storage directories exist and are exported (see <code>docs/nnU-Net_guide.md</code> for the rationale):</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token function">New-Item</span> <span class="token operator">-</span>ItemType Directory <span class="token operator">-</span>Force outputs\nnunet\nnUNet_raw <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
<span class="token function">New-Item</span> <span class="token operator">-</span>ItemType Directory <span class="token operator">-</span>Force outputs\nnunet\nnUNet_preprocessed <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
<span class="token function">New-Item</span> <span class="token operator">-</span>ItemType Directory <span class="token operator">-</span>Force outputs\nnunet\nnUNet_results <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
<span class="token function">New-Item</span> <span class="token operator">-</span>ItemType Directory <span class="token operator">-</span>Force outputs\nnunet\reports\metrics <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

setx nnUNet_raw <span class="token string">"${PWD}\outputs\nnunet\nnUNet_raw"</span>
setx nnUNet_preprocessed <span class="token string">"${PWD}\outputs\nnunet\nnUNet_preprocessed"</span>
setx nnUNet_results <span class="token string">"${PWD}\outputs\nnunet\nnUNet_results"</span>
</code></pre><hr>
<h2 id="2-script-quick-reference">2. Script quick reference </h2>
<ul>
<li>
<p><code>scripts/analyze_statistics.py</code><br>
Purpose: Launch the Dash app for per-case and cohort statistics.<br>
Environment: <code>.venv</code><br>
Typical inputs: dataset roots.<br>
Primary outputs: interactive browser UI and cached JSON files under <code>outputs/statistics_cache/</code>.</p>
</li>
<li>
<p><code>scripts/visualize_volumes.py</code><br>
Purpose: Provide interactive viewing, static PNG export, and GIF generation.<br>
Environment: <code>.venv</code><br>
Typical inputs: BraTS case folders.<br>
Primary outputs: Dash app, PNG figures, GIF animations.</p>
</li>
<li>
<p><code>scripts/prepare_nnunet_dataset.py</code><br>
Purpose: Convert BraTS folders into the nnU-Net v2 dataset structure.<br>
Environment: <code>.venv_nnunet</code><br>
Typical inputs: raw case roots.<br>
Primary outputs: <code>outputs/nnunet/nnUNet_raw/Dataset*/</code> tree and <code>dataset.json</code>.</p>
</li>
<li>
<p><code>scripts/train_monai_finetune.py</code><br>
Purpose: Run two-stage MONAI fine-tuning aligned with nnU-Net folds.<br>
Environment: <code>.venv_monai</code><br>
Typical inputs: case roots plus <code>splits_final.json</code>.<br>
Primary outputs: checkpoints and training logs stored in <code>outputs/monai_ft*/</code>.</p>
</li>
<li>
<p><code>scripts/infer_monai_finetune.py</code><br>
Purpose: Perform sliding-window inference from MONAI checkpoints.<br>
Environment: <code>.venv_monai</code><br>
Typical inputs: case roots, <code>dataset.json</code>, checkpoints.<br>
Primary outputs: NIfTI predictions and optional evaluation reports.</p>
</li>
<li>
<p><code>scripts/compute_brats_lesion_metrics.py</code><br>
Purpose: Compute lesion-wise BraTS metrics comparing predictions to ground truth.<br>
Environment: <code>.venv</code> or <code>.venv_nnunet</code><br>
Typical inputs: ground-truth and prediction directories.<br>
Primary outputs: JSON metrics (per-case and summary).</p>
</li>
<li>
<p><code>scripts/run_full_evaluation.py</code><br>
Purpose: Drive nnU-Net CLI evaluation together with lesion metrics.<br>
Environment: <code>.venv_nnunet</code><br>
Typical inputs: ground-truth and prediction directories.<br>
Primary outputs: nnU-Net metrics, lesion metrics, and a merged manifest.</p>
</li>
<li>
<p><code>scripts/visualize_architecture.py</code><br>
Purpose: Plot nnU-Net architecture details from <code>plans.json</code>.<br>
Environment: <code>.venv</code> (with matplotlib).<br>
Typical inputs: path to <code>plans.json</code>.<br>
Primary outputs: PNG/SVG diagrams and a console table summary.</p>
</li>
</ul>
<hr>
<h2 id="3-detailed-usage-by-script">3. Detailed usage by script </h2>
<h3 id="31-scriptsanalyze_statisticspy">3.1 <code>scripts/analyze_statistics.py</code> </h3>
<p><strong>What it does:</strong> hosts the statistics inspector Dash app with two tabs:</p>
<ul>
<li><em>Case Statistics</em> renders modality histograms and segmentation label tables.</li>
<li><em>Dataset Statistics</em> computes aggregated metrics (spacing, intensity percentiles, label distributions) and caches them under <code>outputs/statistics_cache/</code> for speedy reloads.</li>
</ul>
<p><strong>Run it:</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/analyze_statistics<span class="token punctuation">.</span>py <span class="token operator">--</span><span class="token function">open-browser</span>
</code></pre><p><strong>Key arguments:</strong></p>
<ul>
<li><code>--data-root PATH</code> (repeatable): override the dataset roots (defaults to <code>training_data</code>, <code>training_data_additional</code>, <code>validation_data</code>).</li>
<li><code>--host</code>, <code>--port</code>: bind interface/port (default <code>127.0.0.1:8050</code>).</li>
<li><code>--debug</code>: enable Dash hot reload for development.</li>
<li><code>--open-browser</code>: automatically open the app in the default browser once the server starts.</li>
</ul>
<p><strong>Workflow tips:</strong></p>
<ul>
<li>Launch once per session; cached aggregates avoid recomputation between runs.</li>
<li>The dataset tab exposes <code>Recompute</code> and <code>Load Cached</code> controls—use <code>Recompute</code> after adding new cases.</li>
<li>All case discovery respects the BraTS naming convention; missing modalities raise a visible error.</li>
</ul>
<h3 id="32-scriptsvisualize_volumespy">3.2 <code>scripts/visualize_volumes.py</code> </h3>
<p><strong>What it does:</strong> a single entry point for interactive browsing, static figure export, and GIF animation. Three subcommands are exposed through the <code>--mode</code> flag.</p>
<p><strong>Environments:</strong> base <code>.venv</code> (depends on matplotlib, imageio, Dash).</p>
<h4 id="interactive-mode-dash-app">Interactive mode (Dash app) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/visualize_volumes<span class="token punctuation">.</span>py <span class="token operator">--</span>mode interactive <span class="token operator">--</span><span class="token function">open-browser</span>
</code></pre><ul>
<li>Shares the same Dash backend as <code>analyze_statistics.py</code> but focuses on slice viewers.</li>
<li>Accepts multiple <code>--data-root</code> entries; defaults to all known roots.</li>
<li>Supports <code>--debug</code>, <code>--host</code>, <code>--port</code>, <code>--open-browser</code> like the statistics app.</li>
</ul>
<h4 id="static-figure-mode">Static figure mode </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>python scripts/visualize_volumes<span class="token punctuation">.</span>py <span class="token operator">--</span>mode static `
    <span class="token operator">--</span>case-<span class="token function">dir</span> training_data_additional/BraTS-GLI-02570-100 `
    <span class="token operator">--</span>layout modalities `
    <span class="token operator">--</span>axis axial `
    <span class="token operator">--</span>fraction 0<span class="token punctuation">.</span>55 `
    <span class="token operator">--</span>output outputs/figures/BraTS-GLI-02570-100_modalities<span class="token punctuation">.</span>png
</code></pre><ul>
<li><code>--layout modalities</code> shows all available modalities on one slice; choose slice via <code>--fraction</code> or <code>--index</code>.</li>
<li><code>--layout orthogonal</code> produces sagittal/coronal/axial views for one modality (set with <code>--modality</code> and optional <code>--indices</code>).</li>
<li>Overlays default to on; add <code>--no-overlay</code> to disable segmentation blending.</li>
</ul>
<h4 id="gif-mode">GIF mode </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code>python scripts/visualize_volumes<span class="token punctuation">.</span>py <span class="token operator">--</span>mode gif `
    <span class="token operator">--</span>root training_data_additional `
    <span class="token operator">--</span>case BraTS-GLI-02570-100 `
    <span class="token operator">--</span>axis axial `
    <span class="token operator">--</span>modality t2f `
    <span class="token operator">--</span>step 3 `
    <span class="token operator">--</span>overlay `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/gifs
</code></pre><ul>
<li>Processes either a single case (<code>--case</code>) or a whole root (optionally capped via <code>--max-cases</code>).</li>
<li>Per-frame rendering honours percentile normalization and optional overlays.</li>
<li>GIFs appear in <code>--output-dir</code> named <code>&lt;case&gt;_&lt;modality&gt;_&lt;axis&gt;.gif</code>.</li>
</ul>
<p><strong>Troubleshooting:</strong></p>
<ul>
<li>All modes raise fast if a modality or segmentation is missing—fix the dataset rather than ignoring it.</li>
<li>When running headless, keep <code>--show</code> unset for static mode; figures will still be written to disk.</li>
</ul>
<h3 id="33-scriptsprepare_nnunet_datasetpy">3.3 <code>scripts/prepare_nnunet_dataset.py</code> </h3>
<p><strong>Purpose:</strong> reorganize BraTS folders into the nnU-Net v2 raw format (<code>imagesTr/</code>, <code>labelsTr/</code>, <code>imagesTs/</code>, <code>labelsTs/</code>) and emit a <code>dataset.json</code> describing the cohort.</p>
<p><strong>Run it:</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/prepare_nnunet_dataset<span class="token punctuation">.</span>py `
    <span class="token operator">--</span>clean `
    <span class="token operator">--</span>train-sources training_data training_data_additional `
    <span class="token operator">--</span><span class="token function">test-sources</span> validation_data `
    <span class="token operator">--</span>dataset-id Dataset501_BraTSPostTx
</code></pre><p><strong>Key behaviour:</strong></p>
<ul>
<li>Creates hard links where possible; falls back to copy if the filesystem forbids linking.</li>
<li>Validates that every training case contains all four modalities and a segmentation.</li>
<li>Test cases may omit <code>-seg</code> unless <code>--require-test-labels</code> is specified (recommended when evaluating against labels).</li>
</ul>
<p><strong>Arguments to know:</strong></p>
<ul>
<li><code>--train-sources</code>, <code>--test-sources</code>: override the default roots; accepts multiple directories.</li>
<li><code>--dataset-id</code>: names the folder inside <code>nnUNet_raw</code> and must match downstream training/evaluation IDs.</li>
<li><code>--nnunet-raw</code>: points to a custom raw data root (defaults to <code>outputs/nnunet/nnUNet_raw</code>).</li>
<li><code>--clean</code>: removes any existing dataset folder before rebuilding to prevent stale cases.</li>
<li><code>--require-test-labels</code>: aborts if any test case lacks a segmentation so that <code>labelsTs/</code> stays complete.</li>
</ul>
<p><strong>Outputs:</strong></p>
<ul>
<li><code>outputs/nnunet/nnUNet_raw/&lt;dataset-id&gt;/imagesTr/*.nii.gz</code></li>
<li><code>outputs/nnunet/nnUNet_raw/&lt;dataset-id&gt;/labelsTr/*.nii.gz</code></li>
<li>Optional <code>imagesTs/</code> and <code>labelsTs/</code></li>
<li><code>dataset.json</code> describing modalities and label schema.</li>
</ul>
<p><strong>Follow-up:</strong> always regenerate <code>nnUNet_preprocessed</code> by running <code>nnUNetv2_plan_and_preprocess</code> after dataset structure changes.</p>
<h3 id="34-scriptstrain_monai_finetunepy">3.4 <code>scripts/train_monai_finetune.py</code> </h3>
<p><strong>Purpose:</strong> fine-tune the MONAI BraTS bundle using nnU-Net fold definitions in two stages: decoder/head adaptation (Stage 1) and full-network fine-tuning (Stage 2).</p>
<p><strong>Run it (single fold):</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/train_monai_finetune<span class="token punctuation">.</span>py `
    <span class="token operator">--</span><span class="token keyword keyword-data">data</span><span class="token operator">-</span>root training_data training_data_additional `
    <span class="token operator">--</span><span class="token function">split-json</span> outputs/nnunet/nnUNet_preprocessed/Dataset501_BraTSPostTx/splits_final<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>fold 0 `
    <span class="token operator">--</span>output-root outputs/monai_ft_nnunet_aligned `
    <span class="token operator">--</span>amp
</code></pre><p><strong>Essential inputs:</strong></p>
<ul>
<li>BraTS case roots (segmented cases only).</li>
<li><code>splits_final.json</code> from nnU-Net preprocessing to align folds.</li>
<li>Stable GPU-enabled MONAI environment (<code>.venv_monai</code>).</li>
</ul>
<p><strong>Key arguments:</strong></p>
<ul>
<li><code>--fold</code> (<code>0</code>–<code>4</code> or <code>all</code>): selects the validation fold; <code>all</code> loops through every fold.</li>
<li><code>--stage1-*</code> / <code>--stage2-*</code>: control curriculum parameters such as epochs, learning rates, and gradient accumulation.</li>
<li><code>--patch-size</code>, <code>--spacing</code>: define resampling and crop geometry (defaults mirror nnU-Net plans).</li>
<li><code>--class-weights</code>: specify DiceCE weights for background plus tumor subregions (five values expected).</li>
<li><code>--resume</code>: resume Stage 1 or Stage 2 from a saved checkpoint with stage-aware safety checks.</li>
<li><code>--amp</code>: enable PyTorch automatic mixed precision for faster, memory-friendly runs.</li>
</ul>
<p><strong>Outputs:</strong></p>
<ul>
<li>Checkpoints under <code>outputs/monai_ft*/fold*/checkpoints/</code> (stage best + epoch snapshots).</li>
<li>Metrics log (<code>metrics/training_log.json</code>) capturing per-epoch losses and Dice scores.</li>
<li>Console summary per epoch for quick monitoring.</li>
</ul>
<p><strong>Best practices:</strong></p>
<ul>
<li>Monitor GPU memory; adjust <code>--batch-size</code>, <code>--stage*-accum</code>, or <code>--patch-size</code> on smaller cards.</li>
<li>Use <code>--save-checkpoint-frequency</code> to control periodic snapshots (default: every epoch).</li>
<li>Stage 1 freezes encoder parameters (controlled via <code>--encoder-prefix</code>). Stage 2 unfreezes everything.</li>
</ul>
<h3 id="35-scriptsinfer_monai_finetunepy">3.5 <code>scripts/infer_monai_finetune.py</code> </h3>
<p><strong>Purpose:</strong> run sliding-window inference with the fine-tuned MONAI model, resample predictions back to the original geometry, and optionally trigger evaluation.</p>
<p><strong>Run it (single fold):</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/infer_monai_finetune<span class="token punctuation">.</span>py `
    <span class="token operator">--</span><span class="token keyword keyword-data">data</span><span class="token operator">-</span>root training_data_additional `
    <span class="token operator">--</span>dataset-json outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/dataset<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>fold 0 `
    <span class="token operator">--</span>checkpoint outputs/monai_ft_nnunet_aligned/fold0/checkpoints/stage2_best<span class="token punctuation">.</span>pt `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/monai_ft_nnunet_aligned/predictions/fold0 `
    <span class="token operator">--</span>ground-truth outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/labelsTs `
    <span class="token operator">--</span>run-evaluation `
    <span class="token operator">--</span>evaluation-output outputs/monai_ft_nnunet_aligned/reports_fold0 `
    <span class="token operator">--</span>amp
</code></pre><p><strong>Key concepts:</strong></p>
<ul>
<li>Reuses <code>dataset.json</code> to discover test case IDs and maintain nnU-Net modality ordering.</li>
<li><code>--bundle-name</code>/<code>--bundle-dir</code> control MONAI bundle loading (defaults to Hugging Face <code>MONAI/brats_mri_segmentation</code>).</li>
<li>The script replaces the bundle’s head with a 5-channel Conv3D to match BraTS labels.</li>
</ul>
<p><strong>Important flags:</strong></p>
<ul>
<li><code>--fold</code>: accepts <code>0</code>–<code>4</code> or <code>all</code>; when using <code>all</code>, include <code>{fold}</code> placeholders in <code>--checkpoint</code> and <code>--output-dir</code>.</li>
<li><code>--spacing</code>, <code>--patch-size</code>, <code>--roi-size</code>, <code>--sw-batch-size</code>, <code>--sw-overlap</code>: keep inference geometry aligned with training choices.</li>
<li><code>--ground-truth</code>, <code>--evaluation-output</code>, <code>--run-evaluation</code>: when provided together, the script calls <code>scripts/run_full_evaluation.py</code> after inference.</li>
<li><code>--amp</code>: enables mixed-precision inference.</li>
</ul>
<p><strong>Outputs:</strong></p>
<ul>
<li>NIfTI segmentations saved as <code>&lt;case&gt;.nii.gz</code> under the chosen output directory.</li>
<li>Optional evaluation reports if <code>--run-evaluation</code> is set.</li>
</ul>
<p><strong>Troubleshooting:</strong></p>
<ul>
<li>Ensure the dataset roots include every case listed in <code>dataset.json</code>; missing cases raise <code>FileNotFoundError</code>.</li>
<li>When running <code>--fold all</code>, verify both the checkpoint pattern and output directory include <code>{fold}</code>.</li>
</ul>
<h3 id="36-scriptscompute_brats_lesion_metricspy">3.6 <code>scripts/compute_brats_lesion_metrics.py</code> </h3>
<p><strong>Purpose:</strong> compute lesion-wise Dice and 95% Hausdorff distance for each BraTS sub-region following the 2024 challenge definition (connected components with 26-connectivity).</p>
<p><strong>Run it:</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/compute_brats_lesion_metrics<span class="token punctuation">.</span>py `
    outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/labelsTs `
    outputs/monai_ft_nnunet_aligned/predictions/fold0 `
    <span class="token operator">--</span>output outputs/monai_ft_nnunet_aligned/reports_fold0/lesion_metrics<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>pretty
</code></pre><p><strong>Inputs:</strong> both directories must contain <code>.nii.gz</code> files with consistent case IDs. The script tolerates suffix variations (<code>-seg</code>, <code>_seg</code>, <code>_pred</code>).</p>
<p><strong>Key options:</strong></p>
<ul>
<li><code>--labels</code>: foreground labels to evaluate (defaults to <code>1 2 3 4</code>).</li>
<li><code>--omit-aggregates</code>: skip Tumor Core (TC) and Whole Tumor (WT) aggregates.</li>
<li><code>--pretty</code>: pretty-print the JSON output.</li>
</ul>
<p><strong>Outputs:</strong></p>
<ul>
<li>JSON file containing <code>cases</code> (per-case metrics &amp; lesion tables) and <code>summary</code> (mean/median/min/max/std for each label).</li>
</ul>
<p><strong>Notes:</strong></p>
<ul>
<li>HD95 values for missed/spurious lesions are penalised by the volume diagonal length.</li>
<li>Great companion when predictions are produced outside nnU-Net (e.g., MONAI fine-tuning).</li>
</ul>
<h3 id="37-scriptsrun_full_evaluationpy">3.7 <code>scripts/run_full_evaluation.py</code> </h3>
<p><strong>Purpose:</strong> orchestrate two evaluation passes—nnU-Net’s CLI metrics and the bespoke lesion-wise report—in a single command, emitting a consolidated manifest.</p>
<p><strong>Run it:</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/run_full_evaluation<span class="token punctuation">.</span>py `
    outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/labelsTs `
    outputs/monai_ft_nnunet_aligned/predictions/fold0 `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/monai_ft_nnunet_aligned/reports/fold0 `
    <span class="token operator">--</span>pretty
</code></pre><p><strong>What happens:</strong></p>
<ol>
<li>Invokes <code>nnUNetv2_evaluate_simple</code> (or a custom command via <code>--nnunet-cmd</code>) unless <code>--skip-nnunet</code> is set.</li>
<li>Runs the same lesion-wise computation as <code>compute_brats_lesion_metrics.py</code>.</li>
<li>Writes three JSONs inside <code>--output-dir</code> by default: <code>nnunet_metrics.json</code>, <code>lesion_metrics.json</code>, and <code>full_metrics.json</code>.</li>
</ol>
<p><strong>Useful flags:</strong></p>
<ul>
<li><code>--nnunet-output</code>, <code>--lesion-output</code>, <code>--combined-output</code>: override the default file locations.</li>
<li><code>--skip-nnunet</code>: skip the nnU-Net CLI invocation when the binary is unavailable.</li>
<li><code>--labels</code>, <code>--omit-aggregates</code>: forward these parameters to the lesion metrics module.</li>
</ul>
<p><strong>Requirements:</strong> <code>nnUNetv2_evaluate_simple</code> must be discoverable on <code>PATH</code> (activate <code>.venv_nnunet</code>). If it’s missing, either install nnU-Net v2 or run with <code>--skip-nnunet</code>.</p>
<h3 id="38-scriptsvisualize_architecturepy">3.8 <code>scripts/visualize_architecture.py</code> </h3>
<p><strong>Purpose:</strong> parse <code>plans.json</code> (generated during nnU-Net planning) and render architecture summaries/diagrams for documentation or presentations.</p>
<p><strong>Run it:</strong></p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/visualize_architecture<span class="token punctuation">.</span>py `
    outputs/nnunet/nnUNet_results/Dataset501_BraTSPostTx/nnUNetTrainer__nnUNetPlans__3d_fullres/plans<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>config 3d_fullres `
    <span class="token operator">--</span>output outputs/nnunet/reports/architecture/3d_fullres_overview<span class="token punctuation">.</span>png
</code></pre><p><strong>Features:</strong></p>
<ul>
<li>Smart path resolution: if you pass a directory, filename, or dataset hint, the script searches known nnU-Net result roots and chooses the best match.</li>
<li>Prints a tabular summary (encoder/decoder stages, kernels, strides, feature widths) to the console.</li>
<li>Generates both overview plots and detailed block diagrams; can emit raster (<code>.png</code>) and vector (<code>.svg</code>) outputs.</li>
</ul>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>--config</code>: configuration key within <code>plans.json</code> (default <code>3d_fullres</code>).</li>
<li><code>--output</code>: output path for the overview figure (PNG by default).</li>
<li><code>--detailed-output</code>: path for the detailed block diagram (defaults to <code>&lt;output&gt;_detailed.png</code>).</li>
<li><code>--vector-output</code>, <code>--detailed-vector-output</code>: vector export paths (SVG/PDF depending on suffix).</li>
</ul>
<p><strong>Dependencies:</strong> matplotlib and pandas (already included via <code>requirements.txt</code>). Ensure a GUI-less backend is fine—the script defaults to saving figures rather than showing them.</p>
<hr>
<h2 id="4-end-to-end-workflows">4. End-to-end workflows </h2>
<p>The sections below stitch the individual CLIs into reproducible pipelines. Start with the nnU-Net workflow (which generates the metadata MONAI reuses), then move on to MONAI fine-tuning. Every step shows a ready-to-run command and a table describing the most relevant options.</p>
<h3 id="41-nnu-net-benchmarking-loop">4.1 nnU-Net benchmarking loop </h3>
<h4 id="step-1--prepare-dataset-structure-scriptsprepare_nnunet_datasetpy">Step 1 – Prepare dataset structure (<code>scripts/prepare_nnunet_dataset.py</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/prepare_nnunet_dataset<span class="token punctuation">.</span>py `
    <span class="token operator">--</span>clean `
    <span class="token operator">--</span>train-sources training_data training_data_additional `
    <span class="token operator">--</span><span class="token function">test-sources</span> validation_data `
    <span class="token operator">--</span>dataset-id Dataset501_BraTSPostTx `
    <span class="token operator">--</span>require-<span class="token function">test-labels</span>
</code></pre><ul>
<li><code>--train-sources DIR...</code>: labeled case roots that populate <code>imagesTr/labelsTr</code>; adjust when you need alternate storage locations or want to subset by site.</li>
<li><code>--test-sources DIR...</code>: roots for held-out cases copied into <code>imagesTs/</code>; change this when targeting different validation cohorts.</li>
<li><code>--dataset-id NAME</code>: folder name beneath <code>nnUNet_raw</code>; pick unique IDs for each experiment (for example <code>Dataset502_Internal</code>).</li>
<li><code>--nnunet-raw PATH</code>: overrides the default <code>outputs/nnunet/nnUNet_raw</code>; use when the raw data lives elsewhere (network share, external drive, etc.).</li>
<li><code>--clean</code>: removes any existing dataset folder before rebuilding; enable whenever you regenerate the dataset to avoid stale cases.</li>
<li><code>--require-test-labels</code>: fails if a test case lacks <code>-seg</code> and also creates <code>labelsTs/</code>; disable only when you expect unlabeled test cases.</li>
</ul>
<h4 id="step-2--plan--preprocess-nnunetv2_plan_and_preprocess">Step 2 – Plan &amp; preprocess (<code>nnUNetv2_plan_and_preprocess</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
nnUNetv2_plan_and_preprocess <span class="token operator">-</span>d 501 <span class="token operator">--</span>verify_dataset_integrity <span class="token operator">--</span>no_preprocessing False
</code></pre><ul>
<li><code>-d 501</code>: dataset ID created in Step&nbsp;1; change it whenever you use a custom <code>--dataset-id</code> during preparation.</li>
<li><code>--verify_dataset_integrity</code>: performs a thorough sanity check before preprocessing; disable only for faster reruns when the data was already validated.</li>
<li><code>--no_preprocessing</code>: skips tensor caching when set to <code>True</code>; keep the default (<code>False</code>) unless you just want a plan-only dry run.</li>
<li><code>-c CONFIG</code>: limits preprocessing to a subset of configurations (for example <code>3d_fullres</code>); enable when storage is tight or only one configuration is required.</li>
</ul>
<blockquote>
<p><strong>Artifacts:</strong> This step produces <code>splits_final.json</code>, <code>plans.json</code>, and cached tensors under <code>outputs/nnunet/nnUNet_preprocessed/</code>.</p>
</blockquote>
<h4 id="step-3--train-folds-nnunetv2_train">Step 3 – Train folds (<code>nnUNetv2_train</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
nnUNetv2_train Dataset501_BraTSPostTx 3d_fullres 0 <span class="token operator">--</span>npz <span class="token operator">--</span>device cuda
</code></pre><ul>
<li><code>Dataset501_BraTSPostTx</code>: dataset ID; align with any custom ID you used during preparation.</li>
<li><code>3d_fullres</code>: configuration key; swap to <code>2d</code>, <code>3d_lowres</code>, or another plan when exploring alternatives.</li>
<li><code>0</code>: fold index (<code>0</code>–<code>4</code> or <code>all</code>); run all folds when you need an ensemble.</li>
<li><code>--npz</code>: saves softmax probabilities for visualization (requires <code>hiddenlayer</code>); disable to conserve disk space.</li>
<li><code>--device</code>: target device (<code>cuda</code> or <code>cpu</code>); force CPU training when GPUs are unavailable.</li>
<li><code>--continue_training</code>: resumes an interrupted run; set to <code>True</code> when a matching checkpoint is present.</li>
</ul>
<p>Repeat the command for each fold or replace the final argument with <code>all</code> for sequential training.</p>
<h4 id="step-4--generate-predictions-nnunetv2_predict">Step 4 – Generate predictions (<code>nnUNetv2_predict</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
nnUNetv2_predict <span class="token operator">-</span>i outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/imagesTs `
    <span class="token operator">-</span>o outputs/nnunet/predictions/Dataset501_BraTSPostTx/3d_fullres `
    <span class="token operator">-</span>d Dataset501_BraTSPostTx `
    <span class="token operator">-</span>c 3d_fullres `
    <span class="token operator">-</span>f 0 `
    <span class="token operator">--</span>save_probabilities
</code></pre><ul>
<li><code>-i PATH</code>: input directory containing cases to segment; swap to <code>imagesTr</code> when performing cross-validation checks.</li>
<li><code>-o PATH</code>: destination for NIfTI predictions; point to experiment-specific folders to keep results organized.</li>
<li><code>-d NAME</code>: dataset ID; keep it consistent with whatever you used for training.</li>
<li><code>-c CONFIG</code>: configuration key; choose alternative plans such as <code>2d</code> when needed.</li>
<li><code>-f FOLD...</code>: folds to use (space-separated); supply multiple folds to generate ensemble predictions.</li>
<li><code>--save_probabilities</code>: stores per-class softmax maps; disable when you need to trim disk usage.</li>
</ul>
<h4 id="step-5--consolidate-evaluation-scriptsrun_full_evaluationpy">Step 5 – Consolidate evaluation (<code>scripts/run_full_evaluation.py</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/run_full_evaluation<span class="token punctuation">.</span>py `
    outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/labelsTs `
    outputs/nnunet/predictions/Dataset501_BraTSPostTx/3d_fullres `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/nnunet/reports/metrics/3d_fullres_fold0 `
    <span class="token operator">--</span>pretty
</code></pre><ul>
<li><code>ground_truth</code> (positional): directory with reference segmentations; point to <code>labelsTr</code> when evaluating training folds.</li>
<li><code>predictions</code> (positional): directory containing model outputs; swap in MONAI predictions for head-to-head comparisons.</li>
<li><code>--output-dir PATH</code>: folder for the three JSON reports; separate directories per fold or per experiment keep results tidy.</li>
<li><code>--nnunet-cmd NAME</code>: overrides the evaluator executable (default <code>nnUNetv2_evaluate_simple</code>); use custom builds or wrapper scripts as needed.</li>
<li><code>--labels LIST</code>: foreground labels to score; restrict the list when certain labels are absent.</li>
<li><code>--omit-aggregates</code>: skips Tumor Core and Whole Tumor metrics; enable for strict per-label reporting only.</li>
<li><code>--skip-nnunet</code>: skips the nnU-Net CLI call; rely on it when you only need lesion-wise metrics.</li>
</ul>
<p>Optional extras after evaluation:</p>
<ul>
<li><code>python scripts/visualize_architecture.py ...</code> to export architecture diagrams (<code>plans.json</code>).</li>
<li>Dash apps (<code>analyze_statistics.py</code>, <code>visualize_volumes.py</code>) for qualitative review.</li>
</ul>
<h3 id="42-monai-fine-tuning-pipeline">4.2 MONAI fine-tuning pipeline </h3>
<p>The MONAI workflow reuses the dataset layout, splits, and evaluation harness from the nnU-Net loop. Ensure Steps&nbsp;1–2 above have been completed so that <code>Dataset501_BraTSPostTx</code> and <code>splits_final.json</code> are in place.</p>
<h4 id="step-1--ensure-dataset-artifacts-scriptsprepare_nnunet_datasetpy">Step 1 – Ensure dataset artifacts (<code>scripts/prepare_nnunet_dataset.py</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/prepare_nnunet_dataset<span class="token punctuation">.</span>py `
    <span class="token operator">--</span>train-sources training_data training_data_additional `
    <span class="token operator">--</span><span class="token function">test-sources</span> validation_data `
    <span class="token operator">--</span>dataset-id Dataset501_BraTSPostTx
</code></pre><ul>
<li><code>--train-sources DIR...</code>: same semantics as nnU-Net Step&nbsp;1; point at the cohorts you’ll fine-tune on.</li>
<li><code>--test-sources DIR...</code>: supplies inference cases for MONAI validation or testing; swap or omit if MONAI should ignore a cohort.</li>
<li><code>--dataset-id NAME</code>: drives MONAI path defaults (such as <code>dataset.json</code>); keep it aligned with the nnU-Net artifacts.</li>
<li><code>--require-test-labels</code>: optional guard for evaluation-time label checks; enable when you expect labels for every MONAI evaluation case.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> If Step&nbsp;1 was already run for nnU-Net, rerun with <code>--clean</code> only when the raw data changed.</p>
</blockquote>
<h4 id="step-2--fine-tune-the-monai-bundle-scriptstrain_monai_finetunepy">Step 2 – Fine-tune the MONAI bundle (<code>scripts/train_monai_finetune.py</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/train_monai_finetune<span class="token punctuation">.</span>py `
    <span class="token operator">--</span><span class="token keyword keyword-data">data</span><span class="token operator">-</span>root training_data `
    <span class="token operator">--</span><span class="token function">split-json</span> outputs/nnunet/nnUNet_preprocessed/Dataset501_BraTSPostTx/splits_final<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>fold 1 `
    <span class="token operator">--</span>output-root outputs/monai_ft `
    <span class="token operator">--</span>stage1-epochs 1 `
    <span class="token operator">--</span>stage2-epochs 1 `
    <span class="token operator">--</span>cache-rate 0<span class="token punctuation">.</span>01 `
    <span class="token operator">--</span>head-key <span class="token string">'conv_final'</span> `
    <span class="token operator">--</span>amp
</code></pre><pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/train_monai_finetune<span class="token punctuation">.</span>py `
    <span class="token operator">--</span><span class="token keyword keyword-data">data</span><span class="token operator">-</span>root training_data `
    <span class="token operator">--</span><span class="token function">split-json</span> outputs/nnunet/nnUNet_preprocessed/Dataset501_BraTSPostTx/splits_final<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>fold 0 `
    <span class="token operator">--</span>output-root outputs/monai_ft_continued `
    <span class="token operator">--</span>stage1-epochs 1 `
    <span class="token operator">--</span>stage2-epochs 1 `
    <span class="token operator">--</span>batch-size 3 `
    <span class="token operator">--</span>stage1-accum 4 `
    <span class="token operator">--</span>stage2-accum 4 `
    <span class="token operator">--</span><span class="token function">save-checkpoint</span><span class="token operator">-</span>frequency 5 `
    <span class="token operator">--</span>amp `
    <span class="token operator">--</span>cache-rate 0<span class="token punctuation">.</span>25 `
    <span class="token operator">--</span>load-weights outputs/monai_ft/fold0/checkpoints/stage2_epoch30<span class="token punctuation">.</span>pt
</code></pre><ul>
<li><code>--data-root DIR...</code>: BraTS roots containing modalities plus <code>-seg</code>; add more roots when you want to enlarge the training data.</li>
<li><code>--split-json PATH</code>: nnU-Net folds guaranteeing consistent validation splits; replace this file when you experiment with new fold definitions.</li>
<li><code>--fold {0-4,all}</code>: selects which fold(s) to train; use <code>all</code> for the full five-run sweep or a single index for rapid iteration.</li>
<li><code>--output-root PATH</code>: parent folder for checkpoints and logs; separate directories such as <code>outputs/monai_ft_baseline</code> keep experiments isolated.</li>
<li><code>--stage1-epochs</code>, <code>--stage2-epochs</code>: define the curriculum length for decoder-only vs. full fine-tuning; shorten for smoke tests or extend for deeper convergence.</li>
<li><code>--stage1-lr</code>, <code>--stage2-lr</code>: learning rates for each stage; tune them when loss diverges or plateaus.</li>
<li><code>--batch-size</code>, <code>--stage*-accum</code>: memory controls; lower the batch size or increase accumulation on smaller GPUs.</li>
<li><code>--amp</code>: enables mixed precision; disable it only while debugging numerical issues.</li>
</ul>
<h4 id="step-3--run-monai-inference-scriptsinfer_monai_finetunepy">Step 3 – Run MONAI inference (<code>scripts/infer_monai_finetune.py</code>) </h4>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_monai\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/infer_monai_finetune<span class="token punctuation">.</span>py `
    <span class="token operator">--</span><span class="token keyword keyword-data">data</span><span class="token operator">-</span>root training_data_additional `
    <span class="token operator">--</span>dataset-json outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/dataset<span class="token punctuation">.</span>json `
    <span class="token operator">--</span>fold 0 `
    <span class="token operator">--</span>checkpoint outputs/monai_ft_continued/fold0/checkpoints/stage2_best<span class="token punctuation">.</span>pt `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/monai_ft_continued/predictions/fold0 `
    <span class="token operator">--</span>spacing 1<span class="token punctuation">.</span>0 1<span class="token punctuation">.</span>0 1<span class="token punctuation">.</span>0 `
    <span class="token operator">--</span>roi-size 224 224 144 `
    <span class="token operator">--</span>amp
</code></pre><ul>
<li><code>--data-root DIR...</code>: directories searched for case folders; include multiple roots when combining validation sets.</li>
<li><code>--dataset-json PATH</code>: defines case IDs and modality order (from nnU-Net Step&nbsp;1); switch files if you maintain multiple dataset IDs.</li>
<li><code>--fold {index,all}</code>: controls checkpoint path templating; use <code>all</code> with <code>{fold}</code> placeholders to iterate automatically.</li>
<li><code>--checkpoint PATH</code>: stage 1 or stage 2 weights to load; point to alternate epochs or experiments as needed.</li>
<li><code>--output-dir PATH</code>: destination for predictions; separate per fold or augmentation strategy.</li>
<li><code>--spacing</code>, <code>--patch-size</code>, <code>--roi-size</code>, <code>--sw-batch-size</code>, <code>--sw-overlap</code>: govern resampling and sliding-window inference; keep them aligned with training settings or adjust for memory constraints.</li>
<li><code>--run-evaluation</code>: automatically triggers Step&nbsp;4 upon completion; omit it if you prefer to evaluate later.</li>
<li><code>--ground-truth</code>, <code>--evaluation-output</code>: required only when <code>--run-evaluation</code> is active; direct them to the label source and report directory.</li>
<li><code>--amp</code>: mixed-precision inference; disable on systems with mismatched GPU drivers.</li>
</ul>
<h4 id="step-4--aggregate-metrics-scriptsrun_full_evaluationpy-or-inline-evaluation">Step 4 – Aggregate metrics (<code>scripts/run_full_evaluation.py</code> or inline evaluation) </h4>
<p>If Step&nbsp;3 used <code>--run-evaluation</code>, the reports are already generated. Otherwise, run the evaluation manually:</p>
<pre data-role="codeBlock" data-info="powershell" class="language-powershell powershell"><code><span class="token punctuation">.</span>\<span class="token punctuation">.</span>venv_nnunet\Scripts\Activate<span class="token punctuation">.</span>ps1
python scripts/run_full_evaluation<span class="token punctuation">.</span>py `
    outputs/nnunet/nnUNet_raw/Dataset501_BraTSPostTx/labelsTs `
    outputs/monai_ft_continued/predictions/fold0 `
    <span class="token operator">--</span>output-<span class="token function">dir</span> outputs/monai_ft_continued/reports/fold0 `
    <span class="token operator">--</span>pretty
</code></pre><ul>
<li><code>ground_truth</code>: directory of reference segmentations; switch to <code>training_data</code> labels for fold-specific validation.</li>
<li><code>predictions</code>: directory containing MONAI outputs; point to alternate experiment folders when comparing runs.</li>
<li><code>--output-dir PATH</code>: report location; create separate directories per fold or random seed.</li>
<li><code>--labels</code>, <code>--omit-aggregates</code>: identical semantics to Step&nbsp;5 in the nnU-Net loop; narrow the evaluation scope for partial label comparisons.</li>
<li><code>--skip-nnunet</code>: avoids calling the nnU-Net CLI so you can compute MONAI-only metrics when the executables are unavailable.</li>
</ul>
<h4 id="step-5--visual-qa-optional">Step 5 – Visual QA (optional) </h4>
<ul>
<li>Launch <code>python scripts/analyze_statistics.py --open-browser</code> to confirm intensity/label distributions post-finetuning.</li>
<li>Create presentation assets with <code>python scripts/visualize_volumes.py --mode static ...</code> or <code>--mode gif</code>.</li>
</ul>
<p>Following these two workflows keeps nnU-Net and MONAI results aligned, enabling apples-to-apples comparisons and rapid iteration on BraTS post-treatment experiments.</p>
<ul>
<li>Generate predictions (<code>nnUNetv2_predict ...</code>).</li>
<li>Evaluate directly using <code>run_full_evaluation.py</code> to unify nnU-Net metrics and lesion-wise analysis.</li>
<li>Visualize cases or statistics using the viewer scripts as needed.</li>
</ul>
<h3 id="43-visualization-and-qa-sprint">4.3 Visualization and QA sprint </h3>
<ul>
<li>Launch <code>analyze_statistics.py</code> to validate intensity and label distributions after new data drops.</li>
<li>Use <code>visualize_volumes.py --mode interactive</code> during QA sessions to review tricky cases with overlays.</li>
<li>Export static panels or GIFs when preparing slide decks or reports for stakeholders.</li>
</ul>
<hr>
<h2 id="5-troubleshooting-cheat-sheet">5. Troubleshooting cheat sheet </h2>
<ul>
<li><strong>Symptom:</strong> <code>FileNotFoundError</code> for modalities or segmentations
<ul>
<li>Likely cause: dataset directory is missing the expected files.</li>
<li>Fix: re-stage the offending case and ensure file naming matches <code>Case-Modality.nii.gz</code> exactly.</li>
</ul>
</li>
<li><strong>Symptom:</strong> <code>Could not locate 'nnUNetv2_evaluate_simple' on PATH</code>
<ul>
<li>Likely cause: the nnU-Net environment isn’t active.</li>
<li>Fix: activate <code>.venv_nnunet</code> or adjust <code>PATH</code>; as a fallback, run evaluation with <code>--skip-nnunet</code>.</li>
</ul>
</li>
<li><strong>Symptom:</strong> “Missing segmentation but test labels were requested”
<ul>
<li>Likely cause: <code>--require-test-labels</code> is set while the test set is incomplete.</li>
<li>Fix: provide the missing <code>-seg</code> files or remove the <code>--require-test-labels</code> guard.</li>
</ul>
</li>
<li><strong>Symptom:</strong> CUDA not detected in MONAI scripts
<ul>
<li>Likely cause: wrong environment or GPU driver mismatch.</li>
<li>Fix: confirm <code>.venv_monai</code> is active, reinstall the CUDA 12.4 wheel if needed, and run the GPU availability helper in <code>docs/MONAI_guide.md</code>.</li>
</ul>
</li>
<li><strong>Symptom:</strong> Dash apps show empty dataset lists
<ul>
<li>Likely cause: incorrect <code>--data-root</code> or permission issues.</li>
<li>Fix: verify the roots exist and are readable; the defaults expect <code>training_data*</code> folders in the repository root.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="6-related-resources">6. Related resources </h2>
<ul>
<li><code>docs/usage_guide.md</code> – canonical quick-start and troubleshooting guide.</li>
<li><code>docs/MONAI_guide.md</code> – GPU environment tips and fine-tuning CLI reference tables.</li>
<li><code>docs/nnU-Net_guide.md</code> – full nnU-Net setup, environment variable configuration, and training recipes.</li>
<li><code>tests/test_volume_utils.py</code> &amp; <code>tests/test_rendering.py</code> – unit tests covering slice preparation and rendering helpers.</li>
</ul>
<p>Stay aligned with these workflows to keep the BraTS toolkit reproducible and easy to share across workstations.</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>