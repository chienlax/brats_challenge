# BraTS Post-treatment Dataset Overview

_Last updated: 2025-10-01 via the statistics inspector recompute workflow._

This note captures the latest geometry, intensity, and segmentation summaries for both the core training cohort (`training_data/`) and the supplemental cohort (`training_data_additional/`). Numbers were regenerated by launching `python scripts/analyze_statistics.py`, opening the **Dataset Statistics** tab, and clicking **Recompute** for each dataset. The resulting caches live under `outputs/statistics_cache/` and feed the web UI as well as this documentation.

For interpretation, refer to [data interpretation document](data_interpretation.md)

For more medical-related information, refer to [medical report](medical_report.md)

---

## Dataset snapshot

| Dataset | Cases | Modalities per case | Segmentation | Cache file |
|---------|-------|---------------------|--------------|------------|
| `training_data` | 1,350 | `t1c`, `t1n`, `t2f`, `t2w` | `*-seg.nii.gz` | `outputs/statistics_cache/training_data_stats.json` |
| `training_data_additional` | 271 | `t1c`, `t1n`, `t2f`, `t2w` | `*-seg.nii.gz` | `outputs/statistics_cache/training_data_additional_stats.json` |

All imaging is stored as 3D NIfTI (`.nii.gz`) volumes. Imaging directories remain Git-ignored; obtain them from secure storage before running analytics.

### Validation checklist

1. Install the repo environment with `pip install -r requirements.txt`.
2. Launch the statistics inspector (`python scripts/analyze_statistics.py --open-browser`) and recompute caches after any data drop.
3. Optionally run the legacy scripts in `scripts/deprecated/` for headless summaries or GIF generation.
4. Spot-check suspicious cases with the volume inspector or the case histogram workflow.

---

## Geometry and orientation consistency

| Metric | Observation (`training_data`) | Observation (`training_data_additional`) |
|--------|--------------------------------|------------------------------------------|
| Volume shape | `(182, 218, 182)` for all 1,350 cases | `(182, 218, 182)` for all 271 cases |
| Voxel spacing | `(1.0, 1.0, 1.0)` mm isotropic | `(1.0, 1.0, 1.0)` mm isotropic |
| Orientation | All affines resolve to `('L', 'A', 'S')` | Same (`('L', 'A', 'S')`) |

No outliers were reported by nibabel during loading. Treat these metrics as regression baselines after each data refresh.

---

## Modality coverage & data types

| Modality | Present in `training_data` | Dtypes in `training_data` | Present in `training_data_additional` | Dtypes in `training_data_additional` |
|----------|---------------------------|---------------------------|----------------------------------------|---------------------------------------|
| `t1c` | 1,350 / 1,350 | 865 × `float32`, 463 × `float64`, 22 × `int16` | 271 / 271 | 231 × `float32`, 40 × `float64` |
| `t1n` | 1,350 / 1,350 | 865 × `float32`, 463 × `float64`, 22 × `int16` | 271 / 271 | 231 × `float32`, 40 × `float64` |
| `t2f` | 1,350 / 1,350 | 865 × `float32`, 463 × `float64`, 22 × `int16` | 271 / 271 | 231 × `float32`, 40 × `float64` |
| `t2w` | 1,350 / 1,350 | 843 × `float32`, 463 × `float64`, 44 × `int16` | 271 / 271 | 231 × `float32`, 40 × `float64` |

The lingering `float64` and `int16` volumes should be cast to `float32` during preprocessing to keep training pipelines consistent.

---

## Intensity landscape (p99 aggregate)

Mean of the 99th percentile (`p99`) per modality, with observed min/max across cases:

| Dataset | `t1c` p99 (mean / range) | `t1n` p99 (mean / range) | `t2f` p99 (mean / range) | `t2w` p99 (mean / range) |
|---------|--------------------------|--------------------------|--------------------------|--------------------------|
| `training_data` | 1,842.16 (92.39 → 12,202.66) | 1,611.32 (87.05 → 5,217.71) | 792.37 (53.54 → 2,814.21) | 1,959.27 (208.44 → 6,371.00) |
| `training_data_additional` | 545.61 (123.05 → 2,420.94) | 442.36 (114.60 → 1,915.41) | 434.69 (48.08 → 1,447.11) | 1,034.41 (244.46 → 3,150.36) |

These spreads motivate the default percentile clipping (1st–99th) used by the histogram and GIF utilities. Extreme p99 values usually indicate residual scanner artifacts—flag them during QA.

---

## Segmentation label distribution

Percentages below are relative to tumor-class voxels (labels 1–4). Background (label 0) is reported for completeness but excluded from percentage calculations.

### `training_data`

| Label | Region | Voxels | Share of tumor voxels |
|-------|--------|--------|------------------------|
| 0 | Background | 9,649,363,112 | — |
| 1 | Enhancing tumor (ET) | 2,285,704 | **2.31 %** |
| 2 | Non-enhancing tumor (NET/necrosis) | 66,476,419 | **67.13 %** |
| 3 | Peritumoral edema (ED) | 11,442,955 | **11.56 %** |
| 4 | Resection cavity (RC) | 18,825,010 | **19.01 %** |

### `training_data_additional`

| Label | Region | Voxels | Share of tumor voxels |
|-------|--------|--------|------------------------|
| 0 | Background | 1,937,164,818 | — |
| 1 | Enhancing tumor (ET) | 541,043 | **2.74 %** |
| 2 | Non-enhancing tumor (NET/necrosis) | 14,107,863 | **71.49 %** |
| 3 | Peritumoral edema (ED) | 2,990,458 | **15.15 %** |
| 4 | Resection cavity (RC) | 2,095,490 | **10.62 %** |

Color palette (aligned with BraTS guidance and reused across tooling):

- Label 1 → `#1f77b4` (blue)
- Label 2 → `#d62728` (red)
- Label 3 → `#2ca02c` (green)
- Label 4 → `#f1c40f` (yellow)

---

## Cached outputs & tooling

- `outputs/statistics_cache/*.json` — dataset-level summaries consumed by the Dash UI.
- `scripts/analyze_statistics.py` — launches the interactive statistics inspector (now showing correct label percentages in **Segmentation Label Totals** after the latest bug fix converting cached keys back to integers).
- `scripts/deprecated/summarize_brats_dataset.py` — batch CLI alternative for headless environments.
- `scripts/visualize_brats.py` — modality comparison plots and orthogonal views.
- `scripts/generate_case_statistics.py` — per-case histograms and label tables.
- `scripts/generate_case_gifs.py` — slice GIF automation with optional overlays.
- `scripts/launch_volume_inspector.py` — interactive slice browser with overlay support.

---

## QA playbooks

1. **New data drop**
   - Recompute dataset caches via the statistics inspector.
   - Compare `shape_counts`, `voxel_spacing_counts`, and `orientation_counts` against the tables above.
   - Inspect `dtype_counts`; cast stragglers to `float32` during preprocessing.
   - Review label percentages for unexpected shifts (e.g., missing RC voxels).

2. **Case triage**
   - Generate per-case histograms (`python scripts/generate_case_statistics.py --case CASE_ID`).
   - Launch the volume inspector for spatial validation around anomalous histograms.
   - Produce GIFs for rapid stakeholder review when escalating cases.

3. **Presentation prep**
   - Use `visualize_brats.py --layout orthogonal` to export high-resolution slices.
   - Combine GIFs and statistics tables into briefing decks for clinicians or ML partners.

---

## References

- BraTS Challenge 2025: <https://www.synapse.org/#!Synapse:syn51156910/wiki/>
- Nibabel orientation primer: <https://nipy.org/nibabel/orientation.html>
- Matplotlib colormap tips: <https://matplotlib.org/stable/tutorials/colors/colormap-manipulation.html>

Keep this document in sync with the cached statistics. After updating any analytics code or ingesting new data, recompute caches and refresh the sections above.
